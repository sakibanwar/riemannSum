<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Riemann Sum Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        canvas { touch-action: none; }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4F46E5;
            cursor: pointer;
            border-radius: 50%;
        }
        /* Chrome, Safari, Edge, Opera */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        /* Firefox */
        input[type=number] {
          -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col items-center p-4">

    <!-- Header -->
    <header class="w-full max-w-5xl mb-6 text-center">
        <h1 class="text-3xl font-bold text-slate-900 mb-2">Riemann Sum Visualizer</h1>
        <p class="text-slate-600">Explore how rectangular approximation approaches the exact area.</p>
    </header>

    <!-- Main Control Panel & Canvas -->
    <main class="w-full max-w-5xl bg-white rounded-xl shadow-lg overflow-hidden lg:flex lg:flex-row">
        
        <!-- Controls Sidebar -->
        <div class="p-6 lg:w-1/3 bg-slate-100 border-r border-slate-200 flex flex-col gap-6">
            
            <!-- Function Selection -->
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">Select Function</label>
                <select id="funcSelect" class="w-full p-2 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition">
                    <option value="x2">f(x) = x² (Parabola)</option>
                    <option value="cubic">f(x) = -0.5(x-2)³ + 2 (Cubic)</option>
                    <option value="root">f(x) = 2√x (Square Root)</option>
                    <option value="consumer">Consumer Surplus (Demand: P = 10 - 0.2x²)</option>
                    <option value="producer">Producer Surplus (Supply: P = 0.2x²)</option>
                </select>
            </div>

            <!-- Interval Selection (New) -->
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">Integration Limits</label>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">Start (a)</label>
                        <input type="number" id="startInput" step="0.5" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none font-mono text-sm text-center">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">End (b)</label>
                        <input type="number" id="endInput" step="0.5" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none font-mono text-sm text-center">
                    </div>
                </div>
            </div>

            <!-- Sum Method Selection -->
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">Approximation Method</label>
                <div class="flex gap-2">
                    <button class="method-btn flex-1 py-2 px-3 text-xs font-medium rounded-md bg-white border border-slate-300 hover:bg-indigo-50 active-method" data-method="left">Left</button>
                    <button class="method-btn flex-1 py-2 px-3 text-xs font-medium rounded-md bg-white border border-slate-300 hover:bg-indigo-50" data-method="middle">Mid</button>
                    <button class="method-btn flex-1 py-2 px-3 text-xs font-medium rounded-md bg-white border border-slate-300 hover:bg-indigo-50" data-method="right">Right</button>
                </div>
            </div>

            <!-- Slider Control -->
            <div>
                <div class="flex justify-between mb-2">
                    <label class="text-sm font-semibold text-slate-700">Rectangles (n)</label>
                    <span id="nValue" class="text-sm font-mono font-bold text-indigo-600">4</span>
                </div>
                <input type="range" id="nSlider" min="1" max="200" value="4" class="slider-thumb w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer">
            </div>

            <!-- Animation Controls -->
            <button id="playBtn" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow transition flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                </svg>
                Take to Limit (Animate)
            </button>

            <!-- Stats Box -->
            <div class="mt-auto bg-white p-4 rounded-lg border border-slate-200">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-sm text-slate-500">Approx Area:</span>
                    <span id="approxArea" class="font-mono font-bold text-lg text-indigo-600">0.000</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-slate-500">Exact Integral:</span>
                    <span id="exactArea" class="font-mono font-semibold text-slate-800">0.000</span>
                </div>
                <div class="flex justify-between items-center mt-2 pt-2 border-t border-slate-100">
                    <span class="text-xs text-slate-400">Error:</span>
                    <span id="errorVal" class="font-mono text-xs text-red-500">0.000</span>
                </div>
            </div>
            
            <div id="econNote" class="hidden text-xs text-slate-600 bg-yellow-50 p-2 rounded border border-yellow-200">
                <strong class="text-yellow-700">Economics Mode:</strong>
                <ul class="list-disc ml-4 mt-1 space-y-1">
                    <li><span class="font-semibold text-slate-800">Price Line:</span> Fixed at P = 5</li>
                    <li><span class="font-semibold text-slate-800">Surplus:</span> Area between the curve and the Price line.</li>
                </ul>
            </div>

        </div>

        <!-- Canvas Container -->
        <div class="lg:w-2/3 bg-white relative">
            <canvas id="graphCanvas" class="w-full h-[400px] lg:h-full block"></canvas>
            <!-- Axis Labels -->
            <div class="absolute bottom-4 right-4 bg-white/90 backdrop-blur px-3 py-1 rounded-md text-xs text-slate-500 border shadow-sm pointer-events-none">
                Quantity (x)
            </div>
            <div class="absolute top-4 left-4 bg-white/90 backdrop-blur px-3 py-1 rounded-md text-xs text-slate-500 border shadow-sm pointer-events-none">
                Price / f(x)
            </div>
            <!-- Legend (Dynamic) -->
            <div id="legendContainer" class="absolute top-4 right-4 flex flex-col gap-2 pointer-events-none">
                <!-- Populated by JS -->
            </div>
        </div>

    </main>

<script>
    // --- Configuration & State ---
    const canvas = document.getElementById('graphCanvas');
    const ctx = canvas.getContext('2d');
    
    const state = {
        n: 4,
        method: 'left', // left, right, middle
        funcKey: 'x2',
        isAnimating: false,
        animationId: null
    };

    // Define Functions and their properties
    // Added 'viewDomain' to keep scale static regardless of input limits
    const functions = {
        'x2': {
            f: x => x * x,
            integral: x => (x * x * x) / 3, 
            defaultStart: 0,
            defaultEnd: 4,
            viewDomain: [0, 5], 
            yMax: 20, 
            color: '#4F46E5', 
            name: 'f(x) = x²',
            baseline: 0
        },
        'cubic': {
            f: x => -0.5 * Math.pow(x - 2, 3) + 2,
            integral: x => -0.125 * Math.pow(x - 2, 4) + 2 * x,
            defaultStart: 0,
            defaultEnd: 4,
            viewDomain: [0, 5],
            yMax: 8,
            color: '#0EA5E9', 
            name: 'Cubic',
            baseline: 0
        },
        'root': {
            f: x => 2 * Math.sqrt(x),
            integral: x => (4/3) * Math.pow(x, 1.5),
            defaultStart: 0,
            defaultEnd: 9,
            viewDomain: [0, 10],
            yMax: 8,
            color: '#10B981', 
            name: 'f(x) = 2√x',
            baseline: 0
        },
        'consumer': {
            f: x => 10 - 0.2 * x * x,
            integral: x => 5 * x - (0.2 * Math.pow(x, 3) / 3),
            defaultStart: 0,
            defaultEnd: 5,
            viewDomain: [0, 8],
            yMax: 12,
            color: '#EF4444', 
            name: 'Demand Curve',
            isEcon: true,
            price: 5,
            fillColor: '#FEE2E2', 
            rectType: 'below_curve_above_price'
        },
        'producer': {
            f: x => 0.2 * x * x,
            integral: x => 5 * x - (0.2 * Math.pow(x, 3) / 3),
            defaultStart: 0,
            defaultEnd: 5,
            viewDomain: [0, 8],
            yMax: 12,
            color: '#F59E0B', 
            name: 'Supply Curve',
            isEcon: true,
            price: 5,
            fillColor: '#FEF3C7', 
            rectType: 'above_curve_below_price'
        }
    };

    // DOM Elements
    const startInput = document.getElementById('startInput');
    const endInput = document.getElementById('endInput');
    const funcSelect = document.getElementById('funcSelect');

    // --- Drawing Engine ---

    function resizeCanvas() {
        const parent = canvas.parentElement;
        canvas.width = parent.clientWidth * window.devicePixelRatio;
        canvas.height = parent.clientHeight * window.devicePixelRatio;
        ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
        draw();
    }

    // Coordinate Mapping - Uses Fixed View Domain
    function mapX(x, width, viewMin, viewMax) {
        const padding = 50;
        return padding + ((x - viewMin) / (viewMax - viewMin)) * (width - 2 * padding);
    }

    function mapY(y, height, yMin, yMax) {
        const padding = 50;
        return height - padding - ((y - yMin) / (yMax - yMin)) * (height - 2 * padding);
    }

    function draw() {
        const width = canvas.width / window.devicePixelRatio;
        const height = canvas.height / window.devicePixelRatio;
        const currentFunc = functions[state.funcKey];
        
        // 1. Determine VIEWPORT (Fixed scale based on function)
        const viewXMin = currentFunc.viewDomain[0];
        const viewXMax = currentFunc.viewDomain[1];
        const viewYMin = 0;
        const viewYMax = currentFunc.yMax;

        // 2. Determine INTEGRATION LIMITS (User Input)
        let intStart = parseFloat(startInput.value);
        let intEnd = parseFloat(endInput.value);

        // Validation: If invalid, fallback to defaults
        if (isNaN(intStart)) intStart = currentFunc.defaultStart;
        if (isNaN(intEnd)) intEnd = currentFunc.defaultEnd;
        
        // Ensure intStart < intEnd for calculation logic (swap if needed for math, but keep visuals consistent)
        let calcStart = Math.min(intStart, intEnd);
        let calcEnd = Math.max(intStart, intEnd);

        // Clear
        ctx.clearRect(0, 0, width, height);

        // --- GRID & AXES ---
        ctx.strokeStyle = '#e2e8f0';
        ctx.lineWidth = 1;
        ctx.beginPath();
        // Grid Lines (Horizontal)
        for(let i=0; i<=5; i++) {
            let yVal = viewYMax * (i/5);
            let yPos = mapY(yVal, height, viewYMin, viewYMax);
            ctx.moveTo(30, yPos);
            ctx.lineTo(width - 30, yPos);
        }
        ctx.stroke();

        // Axes Drawing
        ctx.strokeStyle = '#64748b';
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        // Y Axis (at x=0 or clamped)
        let yAxisX = mapX(0, width, viewXMin, viewXMax);
        ctx.moveTo(yAxisX, mapY(viewYMin, height, viewYMin, viewYMax));
        ctx.lineTo(yAxisX, mapY(viewYMax, height, viewYMin, viewYMax));
        
        // X Axis (at y=0)
        let xAxisY = mapY(0, height, viewYMin, viewYMax);
        ctx.moveTo(mapX(viewXMin, width, viewXMin, viewXMax), xAxisY);
        ctx.lineTo(mapX(viewXMax, width, viewXMin, viewXMax), xAxisY);
        ctx.stroke();

        // --- AXIS NUMBERS (LABELS) ---
        ctx.fillStyle = '#64748b';
        ctx.font = '11px Inter';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';

        // X-Axis Labels
        const xStep = Math.ceil((viewXMax - viewXMin) / 10);
        for(let v = Math.ceil(viewXMin); v <= viewXMax; v += xStep) {
            let px = mapX(v, width, viewXMin, viewXMax);
            let py = xAxisY + 8; // slightly below axis
            ctx.fillText(v.toString(), px, py);
        }

        // Y-Axis Labels
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        const yStep = Math.ceil(viewYMax / 5);
        for(let v = 0; v <= viewYMax; v += yStep) {
            let px = yAxisX - 8;
            let py = mapY(v, height, viewYMin, viewYMax);
            ctx.fillText(v.toString(), px, py);
        }

        // --- VISUAL LIMITS (DOTTED LINES) ---
        // Draw vertical lines at integration start/end
        ctx.beginPath();
        ctx.setLineDash([4, 4]);
        ctx.strokeStyle = '#94a3b8'; // Light slate
        ctx.lineWidth = 2;
        
        // Start Line
        let startX = mapX(intStart, width, viewXMin, viewXMax);
        ctx.moveTo(startX, mapY(viewYMin, height, viewYMin, viewYMax));
        ctx.lineTo(startX, mapY(viewYMax, height, viewYMin, viewYMax));
        
        // End Line
        let endX = mapX(intEnd, width, viewXMin, viewXMax);
        ctx.moveTo(endX, mapY(viewYMin, height, viewYMin, viewYMax));
        ctx.lineTo(endX, mapY(viewYMax, height, viewYMin, viewYMax));
        
        ctx.stroke();
        ctx.setLineDash([]); // Reset dash

        // Draw 'a' and 'b' labels near the lines
        ctx.fillStyle = '#475569';
        ctx.font = 'bold 12px Inter';
        ctx.textAlign = 'center';
        ctx.fillText('a', startX, mapY(viewYMax, height, viewYMin, viewYMax) - 15);
        ctx.fillText('b', endX, mapY(viewYMax, height, viewYMin, viewYMax) - 15);


        // --- PRICE LINE (ECON ONLY) ---
        if (currentFunc.price !== undefined) {
            const pY = mapY(currentFunc.price, height, viewYMin, viewYMax);
            const pStartX = mapX(viewXMin, width, viewXMin, viewXMax);
            const pEndX = mapX(viewXMax, width, viewXMin, viewXMax); 

            ctx.beginPath();
            ctx.setLineDash([5, 5]);
            ctx.strokeStyle = '#334155'; // Dark Slate
            ctx.lineWidth = 2;
            ctx.moveTo(pStartX, pY);
            ctx.lineTo(pEndX, pY);
            ctx.stroke();
            ctx.setLineDash([]); 

            // Label Price
            ctx.fillStyle = '#334155';
            ctx.font = 'bold 12px Inter';
            ctx.textAlign = 'left';
            ctx.fillText(`P = ${currentFunc.price}`, pEndX - 70, pY - 10);
        }

        // --- RECTANGLES (RIEMANN SUM) ---
        // NOTE: We use calcStart/calcEnd here, so rects only draw inside the limits
        const dx = (calcEnd - calcStart) / state.n;
        let totalArea = 0;

        ctx.fillStyle = currentFunc.color + '40'; // Transparent fill
        ctx.strokeStyle = currentFunc.color;
        ctx.lineWidth = 1;

        for (let i = 0; i < state.n; i++) {
            let xLeft = calcStart + i * dx;
            let xRight = xLeft + dx;
            
            let xEval;
            if (state.method === 'left') xEval = xLeft;
            else if (state.method === 'right') xEval = xRight;
            else xEval = (xLeft + xRight) / 2;

            let yVal = currentFunc.f(xEval);
            
            // Econ vs Standard Height Logic
            let rectBaseY, rectTopY, rectH_math;

            if (currentFunc.isEcon) {
                const price = currentFunc.price;
                if (currentFunc.rectType === 'below_curve_above_price') {
                    rectBaseY = price;
                    rectTopY = yVal;
                    rectH_math = Math.max(0, yVal - price); 
                } else {
                    rectBaseY = yVal;
                    rectTopY = price;
                    rectH_math = Math.max(0, price - yVal);
                }
            } else {
                rectBaseY = 0;
                rectTopY = yVal;
                rectH_math = yVal;
            }

            totalArea += rectH_math * dx;

            // Coordinate Transformation
            let drawX = mapX(xLeft, width, viewXMin, viewXMax);
            let drawW = mapX(xRight, width, viewXMin, viewXMax) - drawX;
            
            let canvasY_Base = mapY(rectBaseY, height, viewYMin, viewYMax);
            let canvasY_Top = mapY(rectTopY, height, viewYMin, viewYMax);
            
            let drawY = canvasY_Top;
            let drawH = canvasY_Base - canvasY_Top;

            if (drawH < 0) {
                 drawY = canvasY_Base;
                 drawH = canvasY_Top - canvasY_Base;
            }

            // Only draw if height is significant
            if (drawH > 0.5) {
                ctx.fillRect(drawX, drawY, drawW, drawH);
                ctx.strokeRect(drawX, drawY, drawW, drawH);
            }
            
            // Draw Dots
            ctx.beginPath();
            ctx.fillStyle = currentFunc.color;
            let dotX = mapX(xEval, width, viewXMin, viewXMax);
            let dotY = mapY(yVal, height, viewYMin, viewYMax);
            
            // Clip dot to canvas bounds roughly
            if (dotY >= -10 && dotY <= height + 10) {
                ctx.arc(dotX, dotY, 3, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.fillStyle = currentFunc.color + '40'; // Reset fill
        }

        // --- FUNCTION CURVE ---
        // Draw across the entire VIEW domain, not just integration limits
        ctx.strokeStyle = currentFunc.color;
        ctx.lineWidth = 3;
        ctx.beginPath();
        
        const step = (viewXMax - viewXMin) / 300;
        let first = true;
        for (let x = viewXMin; x <= viewXMax; x += step) {
            let yVal = currentFunc.f(x);
            let cx = mapX(x, width, viewXMin, viewXMax);
            let cy = mapY(yVal, height, viewYMin, viewYMax);
            
            // Basic clipping to prevent drawing lines way off canvas
            if (cy < -100 || cy > height + 100) continue;

            if (first) {
                ctx.moveTo(cx, cy);
                first = false;
            } else {
                ctx.lineTo(cx, cy);
            }
        }
        ctx.stroke();

        // --- STATS UPDATE ---
        const actualIntegral = currentFunc.integral(calcEnd) - currentFunc.integral(calcStart);
        document.getElementById('approxArea').innerText = totalArea.toFixed(4);
        document.getElementById('exactArea').innerText = actualIntegral.toFixed(4);
        document.getElementById('errorVal').innerText = Math.abs(actualIntegral - totalArea).toFixed(4);

        // --- LEGEND UPDATE ---
        const legend = document.getElementById('legendContainer');
        legend.innerHTML = ''; 
        
        const div1 = document.createElement('div');
        div1.className = 'bg-white/90 backdrop-blur px-3 py-1 rounded-md text-xs border shadow-sm flex items-center gap-2';
        div1.innerHTML = `<span class="w-3 h-3 rounded-full" style="background:${currentFunc.color}"></span> ${currentFunc.name}`;
        legend.appendChild(div1);

        if(currentFunc.isEcon) {
            const div2 = document.createElement('div');
            div2.className = 'bg-white/90 backdrop-blur px-3 py-1 rounded-md text-xs border shadow-sm flex items-center gap-2';
            div2.innerHTML = `<span class="w-3 h-1 bg-slate-700"></span> Price Line`;
            legend.appendChild(div2);
        }

        const econNote = document.getElementById('econNote');
        if(currentFunc.isEcon) {
            econNote.classList.remove('hidden');
        } else {
            econNote.classList.add('hidden');
        }
    }

    // --- Event Listeners ---

    function loadFunctionDefaults() {
        const key = funcSelect.value;
        const f = functions[key];
        startInput.value = f.defaultStart;
        endInput.value = f.defaultEnd;
    }

    funcSelect.addEventListener('change', (e) => {
        state.funcKey = e.target.value;
        loadFunctionDefaults();
        draw();
    });

    startInput.addEventListener('input', draw);
    endInput.addEventListener('input', draw);

    document.querySelectorAll('.method-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            document.querySelectorAll('.method-btn').forEach(b => {
                b.classList.remove('bg-indigo-100', 'border-indigo-500', 'text-indigo-700', 'active-method');
                b.classList.add('bg-white', 'border-slate-300');
            });
            e.target.classList.remove('bg-white', 'border-slate-300');
            e.target.classList.add('bg-indigo-100', 'border-indigo-500', 'text-indigo-700', 'active-method');
            
            state.method = e.target.dataset.method;
            draw();
        });
    });

    const nSlider = document.getElementById('nSlider');
    const nValueDisplay = document.getElementById('nValue');

    nSlider.addEventListener('input', (e) => {
        state.n = parseInt(e.target.value);
        nValueDisplay.innerText = state.n;
        draw();
    });

    const playBtn = document.getElementById('playBtn');
    
    playBtn.addEventListener('click', () => {
        if (state.isAnimating) {
            stopAnimation();
        } else {
            startAnimation();
        }
    });

    function startAnimation() {
        state.isAnimating = true;
        playBtn.innerHTML = `
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Taking Limit...
        `;
        playBtn.classList.replace('bg-indigo-600', 'bg-red-500');
        playBtn.classList.replace('hover:bg-indigo-700', 'hover:bg-red-600');

        if (state.n >= 200) {
            state.n = 2;
            nSlider.value = 2;
            nValueDisplay.innerText = 2;
        }

        animate();
    }

    function stopAnimation() {
        state.isAnimating = false;
        cancelAnimationFrame(state.animationId);
        playBtn.innerHTML = `
             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
            </svg>
            Take to Limit (Animate)
        `;
        playBtn.classList.replace('bg-red-500', 'bg-indigo-600');
        playBtn.classList.replace('hover:bg-red-600', 'hover:bg-indigo-700');
    }

    function animate() {
        if (!state.isAnimating) return;

        let increment = 1;
        if (state.n > 50) increment = 2;
        if (state.n > 100) increment = 5;

        state.n += increment;

        if (state.n >= 200) {
            state.n = 200;
            draw();
            nSlider.value = state.n;
            nValueDisplay.innerText = state.n;
            stopAnimation();
            return;
        }

        nSlider.value = state.n;
        nValueDisplay.innerText = state.n;
        
        draw();
        state.animationId = requestAnimationFrame(animate);
    }

    document.querySelector('[data-method="left"]').classList.add('bg-indigo-100', 'border-indigo-500', 'text-indigo-700', 'active-method');
    document.querySelector('[data-method="left"]').classList.remove('bg-white', 'border-slate-300');

    loadFunctionDefaults();
    window.addEventListener('resize', resizeCanvas);
    setTimeout(resizeCanvas, 100);

</script>
</body>
</html>
